@model List<WebManageFridgeMQTT.Models.Sp_GetInfoDeviceResult> 
@{
    ViewBag.Title = "Device";
    Layout = "~/Views/Shared/_NewLayout.cshtml";

    WebManageFridgeMQTT.Models.Sp_GetInfoDeviceResult info = Model[0];
}

@section Scripts
{
    <link rel="stylesheet" href="@Url.Content("~/Content/NewEtool/css/leaflet.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Content/NewEtool/css/leaflet.iconlabel.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Content/NewEtool/css/leaflet.label.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Scripts/Leaflet/MarkerCluster.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Scripts/Leaflet/MarkerCluster.Default.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Scripts/Leaflet/MarkerCluster.css")" />
    <link rel="stylesheet" href="@Url.Content("~/Scripts/Leaflet/MarkerCluster.Default.css")" />
<link rel="stylesheet" href="@Url.Content("~/Scripts/Leaflet/font-awesome.css")" />
<link rel="stylesheet" href="@Url.Content("~/Scripts/Leaflet/leaflet.awesome-markers.css")" />
    
    <script type="text/javascript" src="@Url.Content("~/Scripts/Leaflet/leaflet.js")"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/Leaflet/leaflet-google.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/Leaflet/leaflet.iconlabel.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/Leaflet/Label.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/Leaflet/Marker.Label.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/Leaflet/Control.MiniMap.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/Leaflet/Map.Label.js")"></script>

    <script type="text/javascript" src="@Url.Content("~/Scripts/Leaflet/leaflet.markercluster-src.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/Leaflet/GeoFridge.js")"></script>
   
}
<style>
    .row p span {
        font-weight: bold;
    }
    .leaflet-popup-content-wrapper {
        min-width: 610px;
        max-height: 460px;
    }

        .leaflet-popup-content-wrapper .leaflet-popup-content {
            margin: 5px;
        }

    .leaflet-popup-close-button {
        z-index: 99999;
    }

    .tab-pane .row p {
        margin-top: 2px;
        margin-bottom: 2px;
    }
    #notePanel {
        width: 50%;
        z-index:99;
        background-color: #FFFFFF;
        position: absolute;
        border: 1px solid #F2F2F2;
        bottom: 20px;
        right: 0;
        border-radius: 6px;
        opacity: 0.8;
        display: none;
    }
    #lblnote {
        position: absolute;
        color: Blue;
        bottom: 0;
        right: 60px;
        z-index: 1;
    }
    #notePanel table tr td{
        padding:0px;
    }
        #notePanel table tr td img {
            max-height: 21px;
        }
    
</style>
<div id="loading" class="loading">
</div>

<div class="insider">
    <div id="map" class="map">
    </div>
    <button id="lblnote" class="toggle-button mini btn-transparent mt-10">
        <i class="icon-up icon-black" title="Legend"></i>
    </button>
    <div id="notePanel">
        <table>
            <tr>
                <td>
                    <img src="@Url.Content("~/Content/Icon/markers/dangbaoduong.png")" style="margin-left: 5px;" />
                    <span>Đang bảo dưỡng</span>
                </td>
                <td>
                    <img src="@Url.Content("~/Content/Icon/markers/tatbaoduong.png")" style="margin-left: 5px;" />
                    <span>Tắt máy bảo dưỡng</span>
                </td>
                <td>
                    <img src="@Url.Content("~/Content/Icon/markers/dangdichuyen.png")" style="margin-left: 5px;" />
                    <span>Đang di chuyển</span>
                </td>
                <td>
                    <img src="@Url.Content("~/Content/Icon/markers/tatdichuyen.png")" style="margin-left: 5px;" />
                    <span>Tắt máy di chuyển</span>
                </td>
                <td></td>
            </tr>
            <tr>
                <td>
                    <img src="@Url.Content("~/Content/Icon/markers/dangkhoan.png")" style="margin-left: 5px;" />
                    <span>Đang khoan</span>
                </td>
                <td>
                    <img src="@Url.Content("~/Content/Icon/markers/tatkhoan.png")" style="margin-left: 5px;" />
                    <span>Tắt máy khoan</span>
                </td>
                <td>
                    <img src="@Url.Content("~/Content/Icon/markers/dangcau.png")" style="margin-left: 5px;" />
                    <span>Đang cẩu</span>
                </td>
                <td>
                    <img src="@Url.Content("~/Content/Icon/markers/tatcau.png")" style="margin-left: 5px;" />
                    <span>Tắt máy cẩu</span>
                </td>
                <td>
                    <img src="@Url.Content("~/Content/Icon/markers/grey.png")" style="margin-left: 5px;" />
                    <span>Không xác định</span>
                </td>
            </tr>
        </table>
    </div>
    
</div>
<div id="DevicePopupTemplete" style="display:none; z-index:999999; min-width:600px; max-height:450px">
    <div class="tab-header">
        <ul id="ul-tab" class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#info">Thông tin</a></li>
            <li><a data-toggle="tab" href="#detail">Chi Tiết</a></li>
            <li><a data-toggle="tab" href="#activity" onclick="RenderHoatDong('0')">Lịch sữ hoạt động</a></li>
            <li><a data-toggle="tab" href="#dichuyen" onclick="RenderDiChuyen('0')">Lịch sữ di chuyển</a></li>
            <li><a data-toggle="tab" href="#baoduong" onclick="RenderBaoDuong('0');">Bảo dưỡng sửa chửa</a></li>
        </ul>
    </div>
    <div class="tab-content">
        <div id="info" class="tab-pane fade in active">
            <div class="row">
                <div class="col-sm-6">
                    <img style="max-width:200px; max-height:280px; padding-top:12px; padding-bottom:12px; padding-left:20px" src="~/Content/img1.jpg" />
                </div>
                <div class="col-sm-6">
                    <h3 id="TenThietBi">@info.TenThietBi</h3>
                    <p>Trạng thái: <span id="TrangThai">@info.StrTrangThai</span></p>
                    <p>Đã hoạt động: <span id="DaHoatDong">@info.DaHoatDong</span></p>
                    <p>Vị trí: <span id="TenCongTrinh">@info.TenCongTrinh</span></p>
                    <p>Lần thay dầu tiếp theo: <span id="ThayDauTiep">@info.ThayDauTiep</span></p>
                    <p>Lần thay lọc tiếp theo: <span id="ThayLocTiep">@info.ThayLocTiep</span></p>
                </div>
            </div>
        </div>
        <div id="detail" class="tab-pane fade in">
            <div class="row">
                <h3 id="TenThietBi">@info.TenThietBi</h3>
                <p>Loại hình: <span id="LoaiHinh">@info.LoaiHinh</span></p>
                <p>Vị trí hiện tại: <span id="TenCongTrinh">@info.TenCongTrinh</span></p>
                <p>Ngày đến: <span id="ThoiGianVao">@(info.ThoiGianVao.HasValue ? info.ThoiGianVao.Value.ToShortDateString() : "")</span></p>
                <p>Tổng số ngày ở công trình: <span id="NgayOCongTrinh">@info.NgayOCongTrinh Ngày</span></p>
                <p>Đơn giá thuê: <span id="GiaThue">@info.GiaThue  VNĐ</span></p>
                <p>Thành tiền hiện tại: <span id="ThanhTien">@info.ThanhTien VNĐ</span></p>
            </div>
            <p>Hình ảnh báo cáo </p>
            <div class="row">
                <div class="col-xs-4">
                    <img style="max-width: 140px; max-height: 220px; padding-top: 5px; padding-bottom: 5px; padding-left: 10px" src="~/Content/img1.jpg" />
                </div>
                <div class="col-xs-4">
                    <img style="max-width: 140px; max-height: 220px; padding-top: 5px; padding-bottom: 5px; padding-left: 10px; " src="~/Content/img2.jpg" />
                </div>
                <div class="col-xs-4">
                    <img style="max-width: 140px; max-height: 220px; padding-top: 5px; padding-bottom: 5px; padding-left: 10px" src="~/Content/img3.jpg" />
                </div>
            </div>
            <div class="row">
                <p></p>
            </div>
        </div>
        <div id="activity" class="tab-pane">

        </div>
        <div id="dichuyen" class="tab-pane">

        </div>
        <div id="baoduong" class="tab-pane">

        </div>
    </div>
</div>
<script type="text/javascript">
    ///<reference path="~/Scripts/Leaflet/GeoFridge.js" />
    var mapData = [];
    mapData.LayerDevice = L.layerGroup();
    var map = new L.Map('map', {
        center: [16, 106],
        zoom: 7,
        minZoom: 0,
        maxZoom: 23,
        contextmenu: true,
        contextmenuWidth: 240,
        contextmenuItems: [{
            text: 'Initial'
        }
        ]
    }
    );
    
    var googleLayer = new L.Google('ROADMAP');
    map.addLayer(googleLayer);

    $(document).ready(function () {
        

        var data = @Html.Raw(new System.Web.Script.Serialization.JavaScriptSerializer().Serialize(Model));

        for (var i in data) {
            var strIconUrl = 'grey';
            if(data[i].TrangThaiHienTai == 3){
                strIconUrl = 'dangbaoduong';
            }else if(data[i].TrangThaiHienTai == 4){
                strIconUrl = 'tatbaoduong';
            }else if(data[i].TrangThaiHienTai == 5){
                strIconUrl = 'dangdichuyen';
            }else if(data[i].TrangThaiHienTai == 6){
                strIconUrl = 'tatdichuyen';
            }else if(data[i].TrangThaiHienTai == 7){
                strIconUrl = 'dangkhoan';
            }else if(data[i].TrangThaiHienTai == 8){
                strIconUrl = 'tatkhoan';
            }else if(data[i].TrangThaiHienTai == 9){
                strIconUrl = 'dangcau';
            }else if(data[i].TrangThaiHienTai == 10){
                strIconUrl = 'tatcau';
            } else{
                strIconUrl = 'grey';
            }

            RenderMarker([data[i].Latitude, data[i].Longitude], data[i].TenThietBi, RederPopupDevice(data[i]), strIconUrl, mapData.LayerDevice);

            //var marker = new L.Marker(
            //        new L.LatLng(data[i].Latitude, data[i].Longitude)
            //    ).bindPopup(data[i].TenThietBi)
            //	.addTo(map);
        }
        //RenderMarker([10.6655357562, 105.7323638722], 'sdsd', '<p>sdsds</p>', '070', mapData.LayerDevice);


        if(map.hasLayer(mapData.LayerDevice)==false){
            map.addLayer(mapData.LayerDevice);
        }


        $('#lblnote').on('click', function () {
            $('#notePanel').toggle();
        });


    });
    
    function RederPopupDevice(item)
    {
        var btnxemHoatDong = '<button onclick="RenderHoatDong(\''+ item.ThietBiId + '\');"><i class="icon-submit" title="Xem báo cáo"></i>Xem</button>'
        var btnxemDiChuyen = '<button onclick="RenderDiChuyen(\''+ item.ThietBiId + '\');"><i class="icon-submit" title="Xem báo cáo"></i>Xem</button>'
        var btnxemBaoDuong = '<button onclick="RenderBaoDuong(\''+ item.ThietBiId + '\');"><i class="icon-submit" title="Xem báo cáo"></i>Xem</button>'
        var ultab = '<li class="active"><a data-toggle="tab" href="#info">Thông tin</a></li>';
        ultab +=    '<li><a data-toggle="tab" href="#detail">Chi Tiết</a></li>';
        ultab +=    '<li><a data-toggle="tab" href="#activity" onclick="RenderHoatDong(\''+ item.ThietBiId + '\');">Lịch sữ hoạt động</a></li>';
        ultab +=    '<li><a data-toggle="tab" href="#dichuyen" onclick="RenderDiChuyen(\''+ item.ThietBiId + '\');">Lịch sữ di chuyển</a></li>';
        ultab +=    '<li><a data-toggle="tab" href="#baoduong" onclick="RenderBaoDuong(\''+ item.ThietBiId + '\');">Bảo dưỡng sửa chửa</a></li>';


        var htmlData = '';
        var matadata = $('#DevicePopupTemplete');
        var data = matadata.clone();
        data.css('display','');
        data.find('h3[id="TenThietBi"]').html(item.TenThietBi);
        data.find('span[id="TrangThai"]').html(item.StrTrangThai);
        data.find('span[id="DaHoatDong"]').html(item.DaHoatDong);
        data.find('span[id="TenCongTrinh"]').html(item.TenCongTrinh);
        data.find('span[id="ThayDauTiep"]').html(item.ThayDauTiep);
        data.find('span[id="ThayLocTiep"]').html(item.ThayLocTiep);
        data.find('span[id="LoaiHinh"]').html(item.LoaiHinh);
        data.find('span[id="ThoiGianVao"]').html(item.ThoiGianVao);
        data.find('span[id="NgayOCongTrinh"]').html(item.NgayOCongTrinh);
        data.find('span[id="GiaThue"]').html(item.GiaThue);
        data.find('span[id="ThanhTien"]').html(item.ThanhTien);
        data.find('ul[id="ul-tab"]').html(ultab);
        data.find('div[id="btn-xemHoatDong"]').html(btnxemHoatDong); 
        data.find('div[id="btn-xemDiChuyen"]').html(btnxemDiChuyen);
        data.find('div[id="btn-xemBaoDuong"]').html(btnxemBaoDuong);
        var elm = data[0];
        htmlData += elm.outerHTML;
        return htmlData;
    }
    function RenderBaoDuong(thietbiId)
    {
        var strFromDate = $('#strFromDateBaoDuong').val();
        if(strFromDate == undefined)
        {
            strFromDate = '';
        }
        var strToDate = $('#strToDateBaoDuong').val();
        if(strToDate == undefined)
        {
            strToDate = '';
        }
        $("#baoduong").load('@(Url.Action("DeviceModify", "Monitoring"))?thietBiID=' + thietbiId + '&strFromDate=' + strFromDate + '&strToDate=' + strToDate);
    }
    function RenderDiChuyen(thietbiId)
    {
        var strFromDate = $('#strFromDateDiChuyen').val();
        if(strFromDate == undefined)
        {
            strFromDate = '';
        }
        var strToDate = $('#strToDateBaoDuong').val();
        if(strToDate == undefined)
        {
            strToDate = '';
        }
        $("#dichuyen").load('@(Url.Action("DeviceMove", "Monitoring"))?thietBiID=' + thietbiId + '&strFromDate=' + strFromDate + '&strToDate=' + strToDate);
    }
    function RenderHoatDong(thietbiId)
    {
        var strFromDate = $('#strFromDateHoatDong').val();
        if(strFromDate == undefined)
        {
            strFromDate = '';
        }

        var strToDate = $('#strToDateHoatDong').val();
        if(strToDate == undefined)
        {
            strToDate = '';
        }
        $("#activity").load('@(Url.Action("DeviceActivity", "Monitoring"))?thietBiID=' + thietbiId + '&strFromDate=' + strFromDate + '&strToDate=' + strToDate);
    }
</script>